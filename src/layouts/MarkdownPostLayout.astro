---
import Layout from "./Layout.astro";

const { title, description, category, tags, rawBody } = Astro.props;
const tagList = tags?.join(" ") || "";
---

<Layout title={title}>
  <article
    class="mx-auto flex w-full max-w-5xl flex-col gap-10"
    data-post-body={rawBody}
  >
    <header class="space-y-4 border-b border-zinc-200 pb-6 dark:border-zinc-800">
      <div class="flex items-start justify-between gap-6">
        <div class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.3em] text-zinc-500 dark:text-zinc-400">
          <span>{category}</span>
          <span class="text-zinc-300 dark:text-zinc-600">//</span>
          <span>{tagList}</span>
        </div>
        <div class="relative" data-menu>
          <button
            type="button"
            class="flex h-9 w-9 items-center justify-center rounded-full border border-zinc-200 text-lg text-zinc-500 transition hover:border-zinc-400 hover:text-zinc-900 dark:border-zinc-800 dark:text-zinc-400 dark:hover:border-zinc-600 dark:hover:text-zinc-100"
            data-menu-toggle
            aria-label="Open copy menu"
          >
            ...
          </button>
          <div
            class="absolute right-0 top-12 hidden w-48 rounded-2xl border border-zinc-200 bg-white p-2 text-xs uppercase tracking-[0.2em] text-zinc-600 shadow-[0_20px_40px_rgba(15,23,42,0.15)] dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-300 dark:shadow-[0_20px_40px_rgba(0,0,0,0.4)]"
            data-menu-panel
          >
            <button
              type="button"
              class="w-full rounded-xl px-3 py-2 text-left transition hover:bg-zinc-100 hover:text-zinc-900 dark:hover:bg-zinc-900 dark:hover:text-zinc-50"
              data-copy-text
            >
              Copy as text
            </button>
            <button
              type="button"
              class="w-full rounded-xl px-3 py-2 text-left transition hover:bg-zinc-100 hover:text-zinc-900 dark:hover:bg-zinc-900 dark:hover:text-zinc-50"
              data-copy-md
            >
              Copy as Markdown
            </button>
          </div>
        </div>
      </div>
      <div>
        <h1 class="text-3xl font-semibold text-zinc-900 dark:text-zinc-100">{title}</h1>
        {description && <p class="mt-2 text-base text-zinc-600 dark:text-zinc-400">{description}</p>}
      </div>
    </header>
    <div class="prose prose-zinc max-w-none dark:prose-invert">
      <slot />
    </div>
    <div class="flex justify-end">
      <div class="relative" data-menu>
        <button
          type="button"
          class="flex h-9 w-9 items-center justify-center rounded-full border border-zinc-200 text-lg text-zinc-500 transition hover:border-zinc-400 hover:text-zinc-900 dark:border-zinc-800 dark:text-zinc-400 dark:hover:border-zinc-600 dark:hover:text-zinc-100"
          data-menu-toggle
          aria-label="Open copy menu"
        >
          ...
        </button>
        <div
          class="absolute right-0 top-12 hidden w-48 rounded-2xl border border-zinc-200 bg-white p-2 text-xs uppercase tracking-[0.2em] text-zinc-600 shadow-[0_20px_40px_rgba(15,23,42,0.15)] dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-300 dark:shadow-[0_20px_40px_rgba(0,0,0,0.4)]"
          data-menu-panel
        >
          <button
            type="button"
            class="w-full rounded-xl px-3 py-2 text-left transition hover:bg-zinc-100 hover:text-zinc-900 dark:hover:bg-zinc-900 dark:hover:text-zinc-50"
            data-copy-text
          >
            Copy as text
          </button>
          <button
            type="button"
            class="w-full rounded-xl px-3 py-2 text-left transition hover:bg-zinc-100 hover:text-zinc-900 dark:hover:bg-zinc-900 dark:hover:text-zinc-50"
            data-copy-md
          >
            Copy as Markdown
          </button>
        </div>
      </div>
    </div>
  </article>

  <script is:inline>
    const enhanceCodeBlocks = () => {
      const blocks = document.querySelectorAll("pre");
      blocks.forEach((block) => {
        if (block.querySelector("button[data-copy]")) return;

        const wrapper = document.createElement("div");
        wrapper.className = "relative";
        block.parentNode.insertBefore(wrapper, block);
        wrapper.appendChild(block);

        const button = document.createElement("button");
        button.type = "button";
        button.dataset.copy = "true";
        button.textContent = "Copy";
        button.className =
          "absolute right-3 top-3 rounded-full border border-zinc-700/60 bg-zinc-900/80 px-3 py-1 text-[11px] uppercase tracking-[0.2em] text-zinc-100 transition hover:border-zinc-400 hover:text-white";

        button.addEventListener("click", async () => {
          const code = block.querySelector("code");
          const text = code ? code.textContent : block.textContent;
          if (!text) return;

          await navigator.clipboard.writeText(text);
          button.textContent = "Copied";
          setTimeout(() => {
            button.textContent = "Copy";
          }, 1600);
        });

        wrapper.appendChild(button);
      });
    };

    const setupMenus = () => {
      const containers = Array.from(document.querySelectorAll("[data-menu]"));
      const postBody = document.querySelector("[data-post-body]");
      const markdown = postBody?.getAttribute("data-post-body") || "";
      const textVersion = markdown
        .replace(/```[\s\S]*?```/g, (match) => match.replace(/```/g, ""))
        .replace(/`([^`]+)`/g, "$1")
        .replace(/\*\*(.*?)\*\*/g, "$1")
        .replace(/\*(.*?)\*/g, "$1")
        .replace(/^#+\s+/gm, "")
        .replace(/\[(.*?)\]\(.*?\)/g, "$1")
        .trim();

      const closeAll = () => {
        containers.forEach((container) => {
          const panel = container.querySelector("[data-menu-panel]");
          panel?.classList.add("hidden");
        });
      };

      containers.forEach((container) => {
        const toggle = container.querySelector("[data-menu-toggle]");
        const panel = container.querySelector("[data-menu-panel]");
        const copyText = container.querySelector("[data-copy-text]");
        const copyMd = container.querySelector("[data-copy-md]");

        toggle?.addEventListener("click", (event) => {
          event.stopPropagation();
          const isOpen = !panel?.classList.contains("hidden");
          closeAll();
          if (!isOpen) {
            panel?.classList.remove("hidden");
          }
        });

        copyText?.addEventListener("click", async () => {
          if (!textVersion) return;
          await navigator.clipboard.writeText(textVersion);
          closeAll();
        });

        copyMd?.addEventListener("click", async () => {
          if (!markdown) return;
          await navigator.clipboard.writeText(markdown);
          closeAll();
        });
      });

      document.addEventListener("click", (event) => {
        if (event.target.closest("[data-menu]")) return;
        closeAll();
      });
    };

    enhanceCodeBlocks();
    setupMenus();
  </script>
</Layout>
