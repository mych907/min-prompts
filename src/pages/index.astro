---
import Layout from "../layouts/Layout.astro";
import PromptCard from "../components/PromptCard.astro";
import { getCollection } from "astro:content";

const entries = await getCollection("prompts");
const prompts = entries.map((entry) => ({
  title: entry.data.title,
  description: entry.data.description,
  category: entry.data.category,
  tags: entry.data.tags,
  href: `/prompts/${entry.slug}`
}));

const categories = ["All", ...new Set(prompts.map((prompt) => prompt.category))];
const tags = ["All", ...new Set(prompts.flatMap((prompt) => prompt.tags))];
---

<Layout title="Prompt Vault">
  <section class="grid gap-10 lg:grid-cols-[280px_1fr]">
    <aside class="space-y-8 rounded-3xl border border-zinc-200 bg-white/60 p-6 shadow-[0_20px_60px_rgba(15,23,42,0.08)] dark:border-zinc-800 dark:bg-zinc-950/60 dark:shadow-[0_20px_60px_rgba(0,0,0,0.45)]">
      <div class="space-y-4">
        <p class="text-xs uppercase tracking-[0.3em] text-zinc-500 dark:text-zinc-400">Search</p>
        <label class="sr-only" for="prompt-search">Search prompts</label>
        <input
          id="prompt-search"
          name="query"
          autocomplete="off"
          class="w-full rounded-2xl border border-zinc-200 bg-white px-4 py-3 text-sm text-zinc-800 shadow-inner shadow-zinc-100/80 focus:border-zinc-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-zinc-900/70 focus-visible:ring-offset-2 focus-visible:ring-offset-zinc-100 dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-100 dark:shadow-none dark:focus-visible:ring-zinc-100/70 dark:focus-visible:ring-offset-zinc-950"
          type="search"
          placeholder="Find a promptâ€¦ (e.g., API error handling)"
          data-search-input
        />
      </div>
      <div class="space-y-4">
        <p class="text-xs uppercase tracking-[0.3em] text-zinc-500 dark:text-zinc-400">Category</p>
        <div class="flex flex-wrap gap-2" data-category-filters>
          {categories.map((category) => (
            <button
              type="button"
              class="rounded-full border border-zinc-200 px-4 py-2 text-[11px] uppercase tracking-[0.2em] text-zinc-600 transition hover:border-zinc-400 hover:text-zinc-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-zinc-900/80 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:border-zinc-800 dark:text-zinc-400 dark:hover:border-zinc-600 dark:hover:text-zinc-100 dark:focus-visible:ring-zinc-100/80 dark:focus-visible:ring-offset-zinc-950"
              data-category={category}
              data-category-filter
            >
              {category}
            </button>
          ))}
        </div>
      </div>
      <div class="space-y-4">
        <p class="text-xs uppercase tracking-[0.3em] text-zinc-500 dark:text-zinc-400">Tags</p>
        <div class="flex flex-wrap gap-2" data-tag-filters>
          {tags.map((tag) => (
            <button
              type="button"
              class="rounded-full border border-zinc-200 px-4 py-2 text-[11px] uppercase tracking-[0.2em] text-zinc-600 transition hover:border-zinc-400 hover:text-zinc-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-zinc-900/80 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:border-zinc-800 dark:text-zinc-400 dark:hover:border-zinc-600 dark:hover:text-zinc-100 dark:focus-visible:ring-zinc-100/80 dark:focus-visible:ring-offset-zinc-950"
              data-tag={tag}
              data-tag-filter
            >
              {tag}
            </button>
          ))}
        </div>
      </div>
    </aside>
    <div class="space-y-8">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-zinc-500 dark:text-zinc-400">Recent Prompts</p>
          <h2 class="text-balance text-2xl font-semibold text-zinc-900 dark:text-zinc-100">Engineering Library</h2>
        </div>
        <div class="rounded-full border border-zinc-200 px-4 py-2 text-[11px] uppercase tracking-[0.2em] text-zinc-500 dark:border-zinc-800 dark:text-zinc-400">
          {prompts.length} prompts
        </div>
      </div>
      <div class="grid gap-6 md:grid-cols-2" data-prompt-grid>
        {prompts.map((prompt) => (
          <PromptCard {...prompt} />
        ))}
      </div>
      <p class="text-sm text-zinc-500 dark:text-zinc-400" data-empty-state hidden>
        No prompts match the current filters.
      </p>
    </div>
  </section>

  <script is:inline>
    const prompts = Array.from(document.querySelectorAll("[data-prompt-card]"));
    const promptData = prompts.map((card) => ({
      element: card,
      title: card.getAttribute("data-title") || "",
      description: card.getAttribute("data-description") || "",
      category: card.getAttribute("data-category") || "",
      tags: (card.getAttribute("data-tags") || "").split(",")
    }));

    const searchInput = document.querySelector("[data-search-input]");
    const categoryButtons = Array.from(document.querySelectorAll("[data-category-filter]"));
    const tagButtons = Array.from(document.querySelectorAll("[data-tag-filter]"));
    const emptyState = document.querySelector("[data-empty-state]");

    const state = {
      query: "",
      category: "All",
      tag: "All"
    };

    const syncUrl = () => {
      const params = new URLSearchParams();
      if (state.query) params.set("q", state.query);
      if (state.category !== "All") params.set("category", state.category);
      if (state.tag !== "All") params.set("tag", state.tag);
      const next = `${window.location.pathname}${params.toString() ? `?${params}` : ""}`;
      window.history.replaceState(null, "", next);
    };

    const updateActive = (buttons, value, key) => {
      buttons.forEach((button) => {
        const isActive = button.getAttribute(`data-${key}`) === value;
        button.classList.toggle("bg-zinc-900", isActive);
        button.classList.toggle("text-zinc-100", isActive);
        button.classList.toggle("border-zinc-900", isActive);
        button.classList.toggle("dark:bg-zinc-100", isActive);
        button.classList.toggle("dark:text-zinc-900", isActive);
        button.classList.toggle("dark:border-zinc-100", isActive);
        button.classList.toggle("is-active", isActive);
      });
    };

    const resetFilters = () => {
      state.category = "All";
      state.tag = "All";
      updateActive(categoryButtons, state.category, "category");
      updateActive(tagButtons, state.tag, "tag");
      applyFilters();
    };

    const matches = (prompt) => {
      const searchTarget = `${prompt.title} ${prompt.description}`.toLowerCase();
      const queryMatch = searchTarget.includes(state.query.toLowerCase());
      const categoryMatch = state.category === "All" || prompt.category === state.category;
      const tagMatch = state.tag === "All" || prompt.tags.includes(state.tag);
      return queryMatch && categoryMatch && tagMatch;
    };

    const applyFilters = () => {
      let visibleCount = 0;
      promptData.forEach((prompt) => {
        const isVisible = matches(prompt);
        prompt.element.classList.toggle("hidden", !isVisible);
        if (isVisible) {
          visibleCount += 1;
        }
      });
      if (emptyState) {
        emptyState.toggleAttribute("hidden", visibleCount !== 0);
      }
      syncUrl();
    };

    const params = new URLSearchParams(window.location.search);
    const initialQuery = params.get("q") || "";
    const initialCategory = params.get("category") || "All";
    const initialTag = params.get("tag") || "All";
    const availableCategories = new Set(categories);
    const availableTags = new Set(tags);
    state.query = initialQuery;
    state.category = availableCategories.has(initialCategory) ? initialCategory : "All";
    state.tag = availableTags.has(initialTag) ? initialTag : "All";
    if (searchInput) {
      searchInput.value = state.query;
    }

    searchInput?.addEventListener("input", (event) => {
      state.query = event.target.value;
      applyFilters();
    });

    categoryButtons.forEach((button) => {
      button.addEventListener("click", () => {
        state.category = button.getAttribute("data-category");
        updateActive(categoryButtons, state.category, "category");
        applyFilters();
      });
    });

    tagButtons.forEach((button) => {
      button.addEventListener("click", () => {
        state.tag = button.getAttribute("data-tag");
        updateActive(tagButtons, state.tag, "tag");
        applyFilters();
      });
    });

    updateActive(categoryButtons, state.category, "category");
    updateActive(tagButtons, state.tag, "tag");
    applyFilters();

    const clearStaleFilters = () => {
      const activeCategory = document.querySelector("[data-category-filter].is-active");
      const activeTag = document.querySelector("[data-tag-filter].is-active");
      if (!activeCategory && !activeTag) return;

      const params = new URLSearchParams(window.location.search);
      const hasQuery = params.has("q") || params.has("category") || params.has("tag");
      if (!hasQuery) {
        resetFilters();
      }
    };

    window.addEventListener("pageshow", (event) => {
      if (event.persisted) {
        clearStaleFilters();
      }
    });
  </script>
</Layout>
